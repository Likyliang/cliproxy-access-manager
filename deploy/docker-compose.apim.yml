# Usage:
#   cd plugins/cliproxy-access-manager/deploy
#   cp ../.env.example .env
#   mkdir -p data
#   docker compose -f docker-compose.apim.yml up -d --build
services:
  cliproxy-access-manager:
    build:
      context: ..
      dockerfile: deploy/Dockerfile.apim
      args:
        HTTP_PROXY: ${HTTP_PROXY:-}
        HTTPS_PROXY: ${HTTPS_PROXY:-}
        ALL_PROXY: ${ALL_PROXY:-}
        NO_PROXY: ${NO_PROXY:-127.0.0.1,localhost,host.docker.internal}
        GOLANG_PROXY: ${GOLANG_PROXY:-https://proxy.golang.org,direct}
    image: cliproxy-access-manager:latest
    container_name: cliproxy-access-manager
    restart: unless-stopped
    environment:
      # Runtime settings
      CLIPROXY_MGMT_BASE_URL: ${CLIPROXY_MGMT_BASE_URL:-http://host.docker.internal:8317}
      CLIPROXY_MGMT_KEY: ${CLIPROXY_MGMT_KEY:?set CLIPROXY_MGMT_KEY}
      APIM_HTTP_ADDR: ${APIM_HTTP_ADDR:-0.0.0.0:8390}
      APIM_HTTP_AUTH_TOKEN: ${APIM_HTTP_AUTH_TOKEN:-}
      APIM_AUTH_SESSION_TTL: ${APIM_AUTH_SESSION_TTL:-24h}
      APIM_AUTH_COOKIE_NAME: ${APIM_AUTH_COOKIE_NAME:-apim_session}
      APIM_AUTH_COOKIE_SECURE: ${APIM_AUTH_COOKIE_SECURE:-false}
      APIM_ADMIN_EMAIL: ${APIM_ADMIN_EMAIL:-}
      APIM_ADMIN_PASSWORD: ${APIM_ADMIN_PASSWORD:-}
      APIM_DATA_DIR: /data
      APIM_DB_PATH: /data/apim.db
      APIM_KEY_SYNC_INTERVAL: ${APIM_KEY_SYNC_INTERVAL:-30s}
      APIM_USAGE_SYNC_INTERVAL: ${APIM_USAGE_SYNC_INTERVAL:-2m}
      APIM_RECOVERY_CHECK_INTERVAL: ${APIM_RECOVERY_CHECK_INTERVAL:-60s}
      APIM_UPDATE_CHECK_ENABLED: ${APIM_UPDATE_CHECK_ENABLED:-true}
      APIM_UPDATE_CHECK_TIME: ${APIM_UPDATE_CHECK_TIME:-04:00}
      APIM_MANAGEMENT_LATEST_VERSION_URL: ${APIM_MANAGEMENT_LATEST_VERSION_URL:-/v0/management/latest-version}
      APIM_UPDATE_APPLY_COMMAND: ${APIM_UPDATE_APPLY_COMMAND:-}
      APIM_UPDATE_ALLOW_CUSTOM_COMMAND: ${APIM_UPDATE_ALLOW_CUSTOM_COMMAND:-false}
      APIM_UPDATE_AUTO_APPLY_ENABLED: ${APIM_UPDATE_AUTO_APPLY_ENABLED:-false}
      APIM_AUTO_UPDATE_ENABLED: ${APIM_AUTO_UPDATE_ENABLED:-true}
      APIM_AUTO_UPDATE_SERVICE: ${APIM_AUTO_UPDATE_SERVICE:-cliproxy}
      APIM_AUTO_UPDATE_COMPOSE_FILE: ${APIM_AUTO_UPDATE_COMPOSE_FILE:-}
      APIM_AUTO_UPDATE_WORKING_DIR: ${APIM_AUTO_UPDATE_WORKING_DIR:-}
      APIM_HTTP_UPDATE_REQUIRE_AUTH: ${APIM_HTTP_UPDATE_REQUIRE_AUTH:-true}
      APIM_DB_RECOVER_ON_CORRUPT: ${APIM_DB_RECOVER_ON_CORRUPT:-true}
      APIM_RECOVERY_SNAPSHOT_SCAN_LIMIT: ${APIM_RECOVERY_SNAPSHOT_SCAN_LIMIT:-10}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}
      TELEGRAM_ALLOWED_CHAT_IDS: ${TELEGRAM_ALLOWED_CHAT_IDS:-}
      TELEGRAM_ALLOWED_USER_IDS: ${TELEGRAM_ALLOWED_USER_IDS:-}
      TELEGRAM_POLL_INTERVAL: ${TELEGRAM_POLL_INTERVAL:-3s}
      APIM_TELEGRAM_DENY_HIGH_RISK_WHEN_ALLOWLIST_EMPTY: ${APIM_TELEGRAM_DENY_HIGH_RISK_WHEN_ALLOWLIST_EMPTY:-true}

      # Build/runtime proxy (user-provided):
      # HTTP proxy  : http://127.0.0.1:20171
      # SOCKS5 proxy: socks5://127.0.0.1:20170
      HTTP_PROXY: ${HTTP_PROXY:-}
      HTTPS_PROXY: ${HTTPS_PROXY:-}
      NO_PROXY: ${NO_PROXY:-127.0.0.1,localhost,host.docker.internal}
    volumes:
      - ./data:/data
    ports:
      - "127.0.0.1:8390:8390"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - default
      - shared-proxy-network

networks:
  shared-proxy-network:
    external: true
