<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>User Dashboard</title>
  <link rel="stylesheet" href="/web/static/common.css" />
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="row" style="justify-content: space-between;">
        <h2>User Dashboard</h2>
        <div class="row">
          <a href="/web/login">Login</a>
          <a href="/web/admin">Admin</a>
          <button id="logout">Logout</button>
        </div>
      </div>
      <div id="session" class="muted"></div>
    </div>

    <div class="card">
      <h3>My usage summary</h3>
      <div class="row">
        <label>Since <input id="since" value="24h" /></label>
        <button id="refresh" class="primary">Refresh</button>
      </div>
      <div id="summary" class="grid"></div>
    </div>

    <div class="card">
      <h3>My keys</h3>
      <table>
        <thead>
          <tr>
            <th>Key</th><th>Status</th><th>Expires</th><th>Requests</th><th>Tokens</th><th>Remaining</th>
          </tr>
        </thead>
        <tbody id="keys"></tbody>
      </table>
    </div>

    <div class="card">
      <h3>Create purchase request</h3>
      <div class="row">
        <input id="plan" placeholder="Plan ID" value="web-chat-monthly" />
        <input id="note" placeholder="Note" style="min-width: 300px;" />
        <button id="createPurchase" class="primary">Submit</button>
      </div>
      <p id="purchaseMsg" class="msg"></p>
    </div>

    <div class="card">
      <h3>My purchase requests</h3>
      <button id="reloadPurchases">Reload</button>
      <table>
        <thead>
          <tr>
            <th>ID</th><th>Status</th><th>Plan</th><th>Note</th><th>Review note</th><th>Created</th><th>Reviewed</th>
          </tr>
        </thead>
        <tbody id="purchases"></tbody>
      </table>
    </div>
  </div>

  <script src="/web/static/common.js"></script>
  <script>
    const { q, on, api, requireSession, logout, htmlEscape, fmtNum, fmtTime } = window.APIMWeb;

    function remainingText(control) {
      if (!control || (!control.remaining_requests && !control.remaining_tokens && control.remaining_requests !== 0 && control.remaining_tokens !== 0)) {
        return 'unconfigured';
      }
      const r = control.remaining_requests;
      const t = control.remaining_tokens;
      return `req=${r == null ? '∞' : fmtNum(r)} tok=${t == null ? '∞' : fmtNum(t)}`;
    }

    async function loadUsage() {
      const since = q('since').value || '24h';
      const [usage, keys] = await Promise.all([
        api(`/api/v1/user/usage?since=${encodeURIComponent(since)}`),
        api(`/api/v1/user/keys?since=${encodeURIComponent(since)}`),
      ]);

      const s = usage.summary || {};
      const u = usage.usage || {};
      q('summary').innerHTML = [
        `<div class="card"><div class="muted">Email</div><div>${htmlEscape(s.email || '-')}</div></div>`,
        `<div class="card"><div class="muted">Requests</div><div>${fmtNum(u.total_requests || 0)}</div></div>`,
        `<div class="card"><div class="muted">Failed</div><div>${fmtNum(u.failed_requests || 0)}</div></div>`,
        `<div class="card"><div class="muted">Tokens</div><div>${fmtNum(u.total_tokens || 0)}</div></div>`,
        `<div class="card"><div class="muted">Validity</div><div>${s.unlimited ? 'unlimited' : (s.valid_until ? fmtTime(s.valid_until) : '-')}</div></div>`,
      ].join('');

      const rows = (keys.items || []).map((item) => `
        <tr>
          <td class="code">${htmlEscape(item.key)}</td>
          <td>${htmlEscape(item.status || '-')}</td>
          <td>${fmtTime(item.expires_at)}</td>
          <td>${fmtNum(item.total_requests || 0)}</td>
          <td>${fmtNum(item.total_tokens || 0)}</td>
          <td>${htmlEscape(remainingText(item.control))}</td>
        </tr>
      `).join('');
      q('keys').innerHTML = rows || '<tr><td colspan="6" class="muted">No keys</td></tr>';
    }

    async function loadPurchases() {
      const data = await api('/api/v1/purchase-requests/mine?limit=100');
      const rows = (data.items || []).map((item) => `
        <tr>
          <td>${item.id}</td>
          <td>${htmlEscape(item.status || '-')}</td>
          <td>${htmlEscape(item.plan_id || item.plan || '')}</td>
          <td>${htmlEscape(item.note || '')}</td>
          <td>${htmlEscape(item.review_note || '')}</td>
          <td>${fmtTime(item.created_at)}</td>
          <td>${fmtTime(item.reviewed_at)}</td>
        </tr>
      `).join('');
      q('purchases').innerHTML = rows || '<tr><td colspan="7" class="muted">No requests</td></tr>';
    }

    async function main() {
      try {
        const principal = await requireSession(['user']);
        q('session').textContent = `role=${principal.role} email=${principal.email || '-'}`;
      } catch (e) {
        q('session').textContent = `Session error: ${e.message}`;
        return;
      }

      on(q('refresh'), 'click', async () => {
        try { await loadUsage(); } catch (e) { q('session').textContent = `Load failed: ${e.message}`; }
      });

      on(q('logout'), 'click', async () => {
        try {
          await logout();
          window.location.assign('/web/login');
        } catch (e) {
          q('session').textContent = `Logout failed: ${e.message}`;
        }
      });

      on(q('reloadPurchases'), 'click', async () => {
        try { await loadPurchases(); } catch (e) { q('session').textContent = `Load failed: ${e.message}`; }
      });

      on(q('createPurchase'), 'click', async () => {
        q('purchaseMsg').textContent = '';
        try {
          const payload = { plan_id: q('plan').value || '', note: q('note').value || '' };
          const resp = await api('/api/v1/purchase-requests', { method: 'POST', body: JSON.stringify(payload) });
          q('purchaseMsg').textContent = `Submitted request #${resp.item.id}`;
          await loadPurchases();
        } catch (e) {
          q('purchaseMsg').textContent = `Submit failed: ${e.message}`;
        }
      });

      await loadUsage();
      await loadPurchases();
    }

    main();
  </script>
</body>
</html>
